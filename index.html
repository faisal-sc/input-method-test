<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>InputMethodSelection Test</title>

  <style>
    /* Reset & base */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      color: #1b1b1d;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    #root {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    /* Debug banner */
    .debug-banner {
      background: #1b1b1d;
      color: #fff;
      font-size: 11px;
      padding: 6px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }
    .debug-banner span { opacity: 0.6; }
    .debug-banner strong { opacity: 1; color: #6ee7b7; }

    /* Container */
    .container {
      display: flex;
      flex-grow: 1;
      flex-direction: column;
      align-items: center;
      margin: 16px;
    }

    /* Heading */
    .heading {
      display: flex;
      align-items: center;
      gap: 8px;
      text-align: center;
      color: #1b1b1d;
      margin: 0;
      margin-top: 24px;
      margin-bottom: 24px;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.4;
    }

    /* Sparkle icon (SVG inline) */
    .sparkle-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
      color: #6851ff;
    }

    /* FormCard */
    .form-card {
      display: flex;
      flex-direction: column;
      padding: 16px;
      width: calc(100% - 2rem);
      max-width: 35rem;
      background-color: #fff;
      border-radius: 12px;
      margin-top: 8px;
    }
    @media (min-width: 480px) {
      .form-card { width: calc(100% - 4rem); }
    }

    .form-card-label {
      margin-bottom: 16px;
      color: #1b1b1d;
      font-size: 16px;
      font-weight: 400;
      padding-left: 2px;
    }
    .required-hint {
      color: #6b6b6f;
    }

    .form-card-help {
      margin-top: 16px;
      color: #1b1b1d;
      font-size: 11px;
      line-height: 1.4;
      padding-left: 2px;
    }

    /* Add Media Button */
    .add-media-btn {
      width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 20px;
      background: #6851ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      line-height: 1.4;
    }
    .add-media-btn:hover:not(:disabled) { background: #5640d9; }
    .add-media-btn:active:not(:disabled) { background: #4a36c4; }
    .add-media-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .add-media-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Hidden file input */
    .hidden-file-input { display: none; }

    /* Thumbnail Grid */
    .thumbnail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 16px;
      width: 100%;
    }
    .thumbnail-wrapper {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }
    .thumbnail {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #6851ff;
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      padding: 0;
      transition: background 0.15s;
    }
    .remove-btn:hover { background: #5640d9; }
    .remove-btn svg { width: 12px; height: 12px; }

    /* Disclaimer */
    .disclaimer {
      margin-top: 16px;
      color: #6b6b6f;
      font-size: 11px;
      line-height: 1.5;
    }
    .disclaimer a {
      color: #6851ff;
      text-decoration: none;
    }
    .disclaimer a:hover { text-decoration: underline; }

    /* Button Row */
    .button-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: calc(100% - 2rem);
      max-width: 35rem;
      margin-top: 16px;
      padding-bottom: 24px;
    }
    @media (min-width: 480px) {
      .button-row { width: calc(100% - 4rem); }
    }

    /* Skip button */
    .skip-btn {
      background: transparent;
      color: #6851ff;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.15s;
    }
    .skip-btn:hover { background: rgba(104, 81, 255, 0.08); }

    /* Next button */
    .next-btn {
      background: #6851ff;
      color: #fff;
      border: none;
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.15s;
    }
    .next-btn:hover:not(:disabled) { background: #5640d9; }
    .next-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Menu (popover) */
    .menu-wrapper {
      position: relative;
      width: 100%;
    }
    .menu-backdrop {
      position: fixed;
      inset: 0;
      z-index: 49;
    }
    .menu-content {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
      z-index: 50;
      overflow: hidden;
      animation: menu-in 0.15s ease-out;
      padding: 4px 0;
    }
    @keyframes menu-in {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 500;
      color: #1b1b1d;
      cursor: pointer;
      text-align: left;
      transition: background 0.1s;
    }
    .menu-item:hover { background: #f5f5f5; }
    .menu-item:active { background: #ebebeb; }
    .menu-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      color: #6b6b6f;
    }

    /* Validation error toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #1b1b1d;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 100;
      animation: toast-in 0.2s ease-out;
      max-width: calc(100% - 2rem);
      text-align: center;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(8px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-type="module">
    const { useState, useCallback, useRef, useEffect } = React;

    const ACCEPTED_IMAGE_TYPES = ["image/jpeg", "image/png"];
    const IMAGE_SIZE_LIMIT_BYTES = 10 * 1024 * 1024; // 10MB
    const MAX_FILES = 10;

    const isMobileDevice = () => /android|iphone|ipad|ipod/i.test(navigator.userAgent);

    const fileToBase64 = (file) =>
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

    // --- Icons (inline SVG) ---

    const SparkleIcon = () => (
      <svg className="sparkle-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z" />
      </svg>
    );

    const ImagesIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
        <circle cx="8.5" cy="8.5" r="1.5" />
        <polyline points="21 15 16 10 5 21" />
      </svg>
    );

    const XIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18" />
        <line x1="6" y1="6" x2="18" y2="18" />
      </svg>
    );

    const CameraIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
        <circle cx="12" cy="13" r="4" />
      </svg>
    );

    const FolderOpenIcon = () => (
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
      </svg>
    );

    // --- Toast ---

    const Toast = ({ message, onDone }) => {
      useEffect(() => {
        const t = setTimeout(onDone, 3000);
        return () => clearTimeout(t);
      }, [onDone]);
      return <div className="toast">{message}</div>;
    };

    // --- Debug Banner ---

    const DebugBanner = () => {
      const isMobile = isMobileDevice();
      const ua = navigator.userAgent;
      const w = window.innerWidth;
      const h = window.innerHeight;
      const dpr = window.devicePixelRatio;

      return (
        <div className="debug-banner">
          <div><span>Device: </span><strong>{isMobile ? "Mobile" : "Desktop"}</strong></div>
          <div><span>Screen: </span><strong>{w}x{h} @{dpr}x</strong></div>
          <div><span>UA: </span><strong>{ua.length > 60 ? ua.slice(0, 60) + "..." : ua}</strong></div>
        </div>
      );
    };

    // --- FormCard ---

    const FormCard = ({ label, help, isRequired, children }) => (
      <div className="form-card">
        {label && (
          <label className="form-card-label">
            {label}
            {isRequired && <span className="required-hint"> (required)</span>}
          </label>
        )}
        {children}
        {help && <div className="form-card-help">{help}</div>}
      </div>
    );

    // --- Menu ---

    const Menu = ({ trigger, items }) => {
      const [open, setOpen] = useState(false);

      return (
        <div className="menu-wrapper">
          {React.cloneElement(trigger, { onClick: () => setOpen(true) })}
          {open && (
            <React.Fragment>
              <div className="menu-backdrop" onClick={() => setOpen(false)} />
              <div className="menu-content" role="menu">
                {items.map((item, i) => (
                  <button
                    key={i}
                    className="menu-item"
                    role="menuitem"
                    onClick={() => { setOpen(false); item.onClick(); }}
                  >
                    {item.icon}
                    {item.label}
                  </button>
                ))}
              </div>
            </React.Fragment>
          )}
        </div>
      );
    };

    // --- InputMethodSelection ---

    const InputMethodSelection = () => {
      const fileInputRef = useRef(null);
      const [selectedImages, setSelectedImages] = useState([]);
      const [toast, setToast] = useState(null);
      const isMobile = isMobileDevice();

      const openFileInput = useCallback((options) => {
        const input = fileInputRef.current;
        if (!input) return;
        if (options?.capture) {
          input.setAttribute("capture", "environment");
          input.multiple = false;
        } else {
          input.removeAttribute("capture");
          input.multiple = true;
        }
        input.click();
      }, []);

      const handleFileChange = useCallback(async (e) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        const remaining = MAX_FILES - selectedImages.length;
        const validFiles = [];
        let skippedType = 0;
        let skippedSize = 0;

        for (let i = 0; i < Math.min(files.length, remaining); i++) {
          const file = files[i];
          if (!ACCEPTED_IMAGE_TYPES.includes(file.type)) {
            skippedType++;
            continue;
          }
          if (file.size > IMAGE_SIZE_LIMIT_BYTES) {
            skippedSize++;
            continue;
          }
          validFiles.push(file);
        }

        if (skippedType > 0) {
          setToast(`${skippedType} file(s) skipped: only JPEG and PNG accepted`);
        } else if (skippedSize > 0) {
          setToast(`${skippedSize} file(s) skipped: exceeds 10MB limit`);
        }

        const newImages = await Promise.all(
          validFiles.map(async (file) => ({
            file,
            previewUrl: URL.createObjectURL(file),
            base64: await fileToBase64(file),
          }))
        );

        setSelectedImages((prev) => [
          ...prev,
          ...newImages.slice(0, MAX_FILES - prev.length),
        ]);

        e.target.value = "";
      }, [selectedImages.length]);

      const handleRemoveImage = useCallback((index) => {
        setSelectedImages((prev) => {
          const removed = prev[index];
          if (removed) URL.revokeObjectURL(removed.previewUrl);
          return prev.filter((_, i) => i !== index);
        });
      }, []);

      const handleSkip = useCallback(() => {
        alert("Skip pressed — in the real app this navigates to the issue form without photos.");
      }, []);

      const handleNext = useCallback(() => {
        alert(`Next pressed — ${selectedImages.length} image(s) would be sent for AI processing.`);
      }, [selectedImages.length]);

      return (
        <React.Fragment>
          <DebugBanner />
          <div className="container">
            <h2 className="heading">
              <SparkleIcon />
              Show us what happened?
            </h2>

            <FormCard
              label="Add images?"
              help="You can only add up to 10 media files. Supported formats: JPEG, PNG. Maximum file size: 10MB."
              isRequired
            >
              {isMobile ? (
                <Menu
                  trigger={
                    <button
                      className="add-media-btn"
                      disabled={selectedImages.length >= MAX_FILES}
                    >
                      <ImagesIcon />
                      Add media
                    </button>
                  }
                  items={[
                    { icon: <ImagesIcon />, label: "Photo Library", onClick: () => openFileInput() },
                    { icon: <CameraIcon />, label: "Take Photo", onClick: () => openFileInput({ capture: true }) },
                    { icon: <FolderOpenIcon />, label: "Choose Files", onClick: () => openFileInput() },
                  ]}
                />
              ) : (
                <button
                  className="add-media-btn"
                  onClick={() => openFileInput()}
                  disabled={selectedImages.length >= MAX_FILES}
                >
                  <ImagesIcon />
                  Add media
                </button>
              )}

              <input
                ref={fileInputRef}
                className="hidden-file-input"
                type="file"
                accept="image/jpeg,image/png"
                multiple
                onChange={handleFileChange}
              />

              {selectedImages.length > 0 && (
                <div className="thumbnail-grid">
                  {selectedImages.map((image, index) => (
                    <div className="thumbnail-wrapper" key={image.previewUrl}>
                      <img
                        className="thumbnail"
                        src={image.previewUrl}
                        alt={`Selected image ${index + 1}`}
                      />
                      <button
                        className="remove-btn"
                        aria-label="Remove image"
                        onClick={() => handleRemoveImage(index)}
                      >
                        <XIcon />
                      </button>
                    </div>
                  ))}
                </div>
              )}

              <div className="disclaimer">
                By uploading any data, information, templates, content, code, video,
                images or other materials or information of any type, you agree, and
                the administrator of your account has agreed, to SafetyCulture's{" "}
                <a href="https://safetyculture.com/legal/terms-and-conditions" target="_blank" rel="noopener noreferrer">
                  Terms &amp; Conditions
                </a>{" "}
                and{" "}
                <a href="https://safetyculture.com/legal/privacy-policy" target="_blank" rel="noopener noreferrer">
                  Privacy Policy
                </a>
              </div>
            </FormCard>

            <div className="button-row">
              <button className="skip-btn" onClick={handleSkip}>Skip</button>
              <button
                className="next-btn"
                disabled={selectedImages.length === 0}
                onClick={handleNext}
              >
                Next
              </button>
            </div>
          </div>

          {toast && <Toast message={toast} onDone={() => setToast(null)} />}
        </React.Fragment>
      );
    };

    // --- Mount ---
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<InputMethodSelection />);
  </script>
</body>
</html>
